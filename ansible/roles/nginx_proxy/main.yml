---
############################################################
# ROLE: nginx_proxy
#
# Purpose:
# - Install & configure Nginx reverse proxy
# - Route traffic to Spring Boot app
# - Prepare HTTPS-ready config (SSL handled separately)
#
# Tags:
# - nginx
############################################################

############################################################
# 1. VALIDATE REQUIRED VARIABLES
############################################################

- name: "NGINX | Validate required environment variables"
  assert:
    that:
      - lookup('env','NGINX_SERVER_NAME') | length > 0
      - lookup('env','APP_PORT') | length > 0
    fail_msg: >
      Missing required NGINX variables.
      Ensure NGINX_SERVER_NAME and APP_PORT are set in config.env
    success_msg: "NGINX variables validated"

############################################################
# 2. INSTALL NGINX
############################################################

- name: "NGINX | Ensure Nginx is installed"
  apt:
    name: nginx
    state: present
    update_cache: yes

############################################################
# 3. RENDER NGINX CONFIGURATION (HTTP-ONLY INITIALLY)
############################################################

- name: "NGINX | Stop nginx if running (to deploy config safely)"
  service:
    name: nginx
    state: stopped
  ignore_errors: true

- name: "NGINX | Check if SSL certificates exist"
  stat:
    path: "/etc/letsencrypt/live/{{ lookup('env','NGINX_SERVER_NAME') }}/fullchain.pem"
  register: ssl_cert_exists
  when: lookup('env','NGINX_SERVER_NAME') | length > 0

- name: "NGINX | Render nginx site configuration (HTTP-only before SSL)"
  template:
    src: "{% if ssl_cert_exists.stat.exists | default(false) %}nginx.conf.j2{% else %}nginx-http-only.conf.j2{% endif %}"
    dest: "/etc/nginx/sites-available/{{ lookup('env','APP_NAME') }}"
    owner: root
    group: root
    mode: "0644"

############################################################
# 4. ENABLE SITE (SYMLINK)
############################################################

- name: "NGINX | Enable nginx site"
  file:
    src: "/etc/nginx/sites-available/{{ lookup('env','APP_NAME') }}"
    dest: "/etc/nginx/sites-enabled/{{ lookup('env','APP_NAME') }}"
    state: link
    force: true

############################################################
# 5. DISABLE DEFAULT SITE (OPTIONAL BUT CLEAN)
############################################################

- name: "NGINX | Disable default nginx site"
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent

############################################################
# 6. VALIDATE NGINX CONFIG
############################################################

- name: "NGINX | Validate nginx configuration"
  command: nginx -t
  register: nginx_test
  changed_when: false
  failed_when: nginx_test.rc != 0

############################################################
# 7. START NGINX (SO APP IS ACCESSIBLE VIA IP)
############################################################

- name: "NGINX | Start nginx service"
  service:
    name: nginx
    state: started
    enabled: true

############################################################
# 8. FINAL STATUS
############################################################

- name: "NGINX | Reverse proxy configured successfully"
  debug:
    msg:
      - "Nginx installed and running (HTTP-only mode)"
      - "Site enabled for domain {{ lookup('env','NGINX_SERVER_NAME') | default('(using IP)') }}"
      - "Proxying traffic to application port {{ lookup('env','APP_PORT') }}"
      - "Application accessible via http://SERVER_IP"
      - "HTTPS will be enabled after SSL certificate generation"
