---
############################################################
# ROLE: app_deployment
#
# Purpose:
# - Authenticate to Docker registry (optional)
# - Render docker-compose.yml from template
# - Pull images (config-driven)
# - Build images (config-driven)
# - Start application containers
# - Validate application readiness
#
# Tags:
# - app
############################################################

############################################################
# 1. VALIDATE REQUIRED ENVIRONMENT VARIABLES
############################################################

- name: "APP | Validate required environment variables"
  assert:
    that:
      - lookup('env','INSTALL_DIR') | length > 0
      - lookup('env','APP_IMAGE') | length > 0
      - lookup('env','APP_PORT') | length > 0
    fail_msg: >
      Required environment variables are missing.
      Ensure config.env is correct and bootstrap.sh exported variables.
    success_msg: "Application environment variables validated"

############################################################
# 1.5 NETWORK & DNS CHECKS
############################################################

- name: "APP | Check and fix DNS resolution"
  block:
    - name: "APP | Test DNS resolution"
      shell: nslookup registry-1.docker.io 8.8.8.8 >/dev/null 2>&1
      register: dns_test
      failed_when: false
      changed_when: false

    - name: "APP | Add Google DNS to resolv.conf if DNS fails"
      lineinfile:
        path: /etc/resolv.conf
        line: "nameserver 8.8.8.8"
        insertbefore: BOF
      when: dns_test.rc != 0

    - name: "APP | Restart systemd-resolved if available"
      service:
        name: systemd-resolved
        state: restarted
      when: dns_test.rc != 0
      ignore_errors: yes

############################################################
# 2. CREATE INSTALL DIRECTORY
############################################################

- name: "APP | Ensure application install directory exists"
  file:
    path: "{{ lookup('env','INSTALL_DIR') }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: "APP | Ensure log directories exist with proper permissions"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
    recurse: yes
  loop:
    - "{{ lookup('env','APP_LOG_DIR') }}"
    - "{{ lookup('env','DZI_LOG_DIR') }}"

- name: "APP | Ensure MinIO directories exist with proper permissions"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
    recurse: yes
  loop:
    - "{{ lookup('env','MINIO_DATA_DIR') }}"
    - "{{ lookup('env','MINIO_CERTS_DIR') }}"
    - "{{ lookup('env','MINIO_CONFIG_DIR') }}"

############################################################
# 3. DOCKER REGISTRY LOGIN (NON-INTERACTIVE)
############################################################
# Handles private Docker images non-interactively

- name: "APP | Check if Docker credentials are provided"
  set_fact:
    docker_creds_available: "{{ (lookup('env','DOCKER_USERNAME') | default('') | length > 0) and (lookup('env','DOCKER_PASSWORD') | default('') | length > 0) }}"

- name: "APP | Verify docker group and permissions"
  block:
    - name: "APP | Check docker socket permissions"
      file:
        path: /var/run/docker.sock
        owner: root
        group: docker
        mode: "0660"
      ignore_errors: yes

    - name: "APP | Test docker access without sudo"
      command: docker info
      register: docker_access_test
      failed_when: false
      changed_when: false

    - name: "APP | Warning about docker permissions"
      debug:
        msg: "WARNING: Docker access test failed. Will use sudo for docker commands."
      when: docker_access_test.rc != 0

- name: "APP | Login to Docker registry using command line"
  shell: |
    echo "{{ lookup('env','DOCKER_PASSWORD') }}" | docker login -u "{{ lookup('env','DOCKER_USERNAME') }}" --password-stdin {{ lookup('env','DOCKER_REGISTRY') | default('docker.io') }}
  when: docker_creds_available | bool
  no_log: true
  register: docker_login_cmd
  failed_when: false
  changed_when: docker_login_cmd.rc == 0

- name: "APP | Check docker login status"
  fail:
    msg: |
      Docker login failed. Please check:
      1. DOCKER_USERNAME is correct in config.env
      2. DOCKER_PASSWORD is correct in config.env
      3. You have access to the repository: {{ lookup('env','APP_IMAGE') }}
      4. Repository exists and is private (requires login)
      
      Error: {{ docker_login_cmd.stderr if docker_login_cmd.stderr is defined else 'Unknown error' }}
  when: 
    - docker_creds_available | bool
    - docker_login_cmd.rc != 0

- name: "APP | Docker login status"
  debug:
    msg: >
      Docker registry login: {{
        'Success' if (docker_creds_available | bool and docker_login_cmd.rc == 0)
        else 'Skipped (no credentials provided - using public images)'
      }}

- name: "APP | Pull images manually to verify access"
  command: docker pull {{ item }}
  loop:
    - "{{ lookup('env','APP_IMAGE') }}"
    - "{{ lookup('env','DB_IMAGE') }}"
    - "{{ lookup('env','DZI_IMAGE') }}"
    - "{{ lookup('env','MINIO_IMAGE') }}"
  register: pull_result
  failed_when: false
  changed_when: pull_result.rc == 0
  when: lookup('env','DOCKER_COMPOSE_PULL') | default('true') | lower == 'true'

- name: "APP | Check if any pulls failed"
  debug:
    msg: "WARNING: Failed to pull {{ item.item }}. Error: {{ item.stderr }}"
  loop: "{{ pull_result.results }}"
  when: 
    - lookup('env','DOCKER_COMPOSE_PULL') | default('true') | lower == 'true'
    - item.rc != 0
  loop_control:
    label: "{{ item.item }}"

############################################################
# 4. RENDER DOCKER COMPOSE FILE
############################################################

- name: "APP | Render docker-compose.yml from template"
  template:
    src: docker-compose.yml.j2
    dest: "{{ lookup('env','INSTALL_DIR') }}/docker-compose.yml"
    owner: root
    group: root
    mode: "0644"

############################################################
# 5. PRE-DEPLOYMENT CHECKS
############################################################

- name: "APP | Check internet connectivity"
  shell: ping -c 1 8.8.8.8 >/dev/null 2>&1 || ping -c 1 1.1.1.1 >/dev/null 2>&1
  register: internet_check
  failed_when: false
  changed_when: false

- name: "APP | Check Docker Hub DNS resolution"
  shell: nslookup registry-1.docker.io >/dev/null 2>&1 || host registry-1.docker.io >/dev/null 2>&1
  register: dns_check
  failed_when: false
  changed_when: false

- name: "APP | Warning about connectivity"
  debug:
    msg: "WARNING: Internet or DNS issues detected. Will attempt to use cached images."
  when: internet_check.rc != 0 or dns_check.rc != 0

- name: "APP | Check for port conflicts"
  shell: |
    lsof -i :{{ item.port }} -t 2>/dev/null || netstat -tuln | grep -q ":{{ item.port }}" && echo "in-use" || echo "free"
  register: port_check
  changed_when: false
  failed_when: false
  loop:
    - { port: "{{ lookup('env','APP_PORT') }}", name: "Application" }
    - { port: "{{ lookup('env','DB_PORT') }}", name: "Database" }
    - { port: "{{ lookup('env','MINIO_PORT') }}", name: "MinIO" }
    - { port: "{{ lookup('env','MINIO_CONSOLE_PORT') }}", name: "MinIO Console" }
  loop_control:
    label: "{{ item.name }} ({{ item.port }})"

- name: "APP | Stop conflicting services on required ports"
  block:
    - name: "APP | Detect PostgreSQL service on port 5432"
      shell: systemctl is-active postgresql 2>/dev/null || echo "not-found"
      register: postgres_service
      changed_when: false

    - name: "APP | Stop PostgreSQL service if running"
      service:
        name: postgresql
        state: stopped
      when: postgres_service.stdout == "active"
      
    - name: "APP | Display stopped services"
      debug:
        msg: "Stopped PostgreSQL service to free port 5432 for Docker container"
      when: postgres_service.stdout == "active"

    - name: "APP | Check for any remaining processes on critical ports"
      shell: |
        PORTS=({{ lookup('env','APP_PORT') }} {{ lookup('env','DB_PORT') }} {{ lookup('env','MINIO_PORT') }})
        CONFLICTS=""
        for PORT in "${PORTS[@]}"; do
          PID=$(lsof -ti:$PORT 2>/dev/null || true)
          if [ -n "$PID" ]; then
            PROCESS=$(ps -p $PID -o comm= 2>/dev/null || echo "unknown")
            CONFLICTS="$CONFLICTS Port $PORT in use by PID $PID ($PROCESS);"
          fi
        done
        if [ -n "$CONFLICTS" ]; then
          echo "$CONFLICTS"
          exit 1
        fi
      register: port_conflicts
      failed_when: false
      changed_when: false

    - name: "APP | Kill processes using required ports (force)"
      shell: |
        PORTS=({{ lookup('env','APP_PORT') }} {{ lookup('env','DB_PORT') }} {{ lookup('env','MINIO_PORT') }} {{ lookup('env','MINIO_CONSOLE_PORT') }})
        for PORT in "${PORTS[@]}"; do
          PID=$(lsof -ti:$PORT 2>/dev/null || true)
          if [ -n "$PID" ]; then
            echo "Killing process $PID on port $PORT"
            kill -9 $PID 2>/dev/null || true
          fi
        done
      when: port_conflicts.rc != 0
      register: kill_result

    - name: "APP | Wait for ports to be released"
      wait_for:
        port: "{{ item }}"
        state: stopped
        timeout: 10
      loop:
        - "{{ lookup('env','APP_PORT') }}"
        - "{{ lookup('env','DB_PORT') }}"
        - "{{ lookup('env','MINIO_PORT') }}"
        - "{{ lookup('env','MINIO_CONSOLE_PORT') }}"
      ignore_errors: yes
      when: port_conflicts.rc != 0 or postgres_service.stdout == "active"

############################################################
# 6. STOP EXISTING CONTAINERS (CLEAN START)
############################################################

- name: "APP | Stop any existing containers"
  command: docker compose down
  args:
    chdir: "{{ lookup('env','INSTALL_DIR') }}"
  register: docker_down
  failed_when: false
  changed_when: docker_down.rc == 0

############################################################
# 7. BUILD & START CONTAINERS (WITH RETRY)
############################################################

- name: "APP | Build and start containers with docker compose"
  command: >
    docker compose up
    {{ '--build' if lookup('env','DOCKER_FORCE_REBUILD') | default('false') | lower == 'true' else '' }}
    --remove-orphans
    -d
  args:
    chdir: "{{ lookup('env','INSTALL_DIR') }}"
  environment:
    DOCKER_CLI_HINTS: "false"
  register: docker_up
  retries: 3
  delay: 10
  until: docker_up.rc == 0
  failed_when: false

- name: "APP | Check if docker compose up failed"
  fail:
    msg: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘         Docker Compose Failed to Start Containers                 â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      {% if 'address already in use' in docker_up.stderr %}
      ğŸ”´ PORT CONFLICT DETECTED:
      
      One or more required ports are already in use by another service.
      The deployment attempted to automatically stop conflicting services,
      but some processes are still holding the ports.
      
      Common culprits:
      - PostgreSQL system service on port 5432
      - Another application on port 8080
      - Another MinIO instance on port 9000
      
      SOLUTION:
      1. Find which process is using the port:
         sudo lsof -i :5432
         sudo lsof -i :8080
         sudo lsof -i :9000
      
      2. Stop the service:
         sudo systemctl stop postgresql
         sudo systemctl disable postgresql
      
      3. Or kill the process:
         sudo kill -9 $(lsof -ti:5432)
      
      4. Then rerun deployment:
         sudo bash bootstrap.sh
      
      {% elif 'denied' in docker_up.stderr or 'login' in docker_up.stderr %}
      ğŸ”´ DOCKER AUTHENTICATION FAILED:
      
      Cannot pull private images. Check your Docker Hub credentials.
      
      SOLUTION:
      1. Update config.env with correct credentials:
         DOCKER_USERNAME=your_username
         DOCKER_PASSWORD=your_password_or_token
      
      2. Test login manually:
         echo "YOUR_PASSWORD" | docker login -u YOUR_USERNAME --password-stdin
      
      3. Rerun deployment:
         sudo bash bootstrap.sh
      
      {% elif 'timeout' in docker_up.stderr or 'i/o timeout' in docker_up.stderr %}
      ğŸ”´ NETWORK/DNS TIMEOUT:
      
      Cannot reach Docker Hub to download images.
      
      SOLUTION:
      1. Check internet connection:
         ping 8.8.8.8
      
      2. Fix DNS:
         echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
         sudo systemctl restart systemd-resolved
      
      3. Rerun deployment:
         sudo bash bootstrap.sh
      
      {% else %}
      ğŸ”´ UNKNOWN ERROR:
      
      Docker Compose failed for an unknown reason.
      
      {% endif %}
      
      Full Error Output:
      {{ docker_up.stderr }}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  when: docker_up.rc != 0

############################################################
# 8. WAIT FOR APPLICATION PORT
############################################################

- name: "APP | Wait for application to be reachable"
  wait_for:
    host: 127.0.0.1
    port: "{{ lookup('env','APP_PORT') }}"
    timeout: 60

############################################################
# 8. VERIFY RUNNING CONTAINERS
############################################################

- name: "APP | List running containers"
  command: docker compose ps
  args:
    chdir: "{{ lookup('env','INSTALL_DIR') }}"
  register: docker_ps
  changed_when: false

- name: "APP | Show container status"
  debug:
    msg: "{{ docker_ps.stdout_lines }}"

############################################################
# 9. FINAL STATUS
############################################################

- name: "APP | Application deployment completed successfully"
  debug:
    msg:
      - "Docker registry login: OK (if required)"
      - "Docker Compose file rendered"
      - "Images pulled: {{ lookup('env','DOCKER_COMPOSE_PULL') }}"
      - "Force rebuild: {{ lookup('env','DOCKER_FORCE_REBUILD') }}"
      - "Application running on port {{ lookup('env','APP_PORT') }}"
