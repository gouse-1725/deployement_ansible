---
############################################################
# ROLE: ssh_access
#
# Purpose:
# - Install OpenSSH server
# - Ensure SSH service is running
# - Create SSH user
# - Install developer public keys
# - Validate SSH daemon health
#
# Tags:
# - ssh
############################################################

############################################################
# 1. INSTALL OPENSSH SERVER
############################################################

- name: "SSH | Ensure OpenSSH server is installed"
  apt:
    name: openssh-server
    state: present
    update_cache: yes

############################################################
# 2. ENABLE & START SSH SERVICE
############################################################

- name: "SSH | Enable and start SSH service"
  service:
    name: ssh
    state: started
    enabled: true

############################################################
# 3. VERIFY SSH PORT
############################################################

- name: "SSH | Verify SSH port is listening"
  wait_for:
    port: "{{ lookup('env','SSH_PORT') | default('22') }}"
    timeout: 10
  register: ssh_port_check

############################################################
# 4. CREATE SSH USER
############################################################

- name: "SSH | Check if SSH_USER is defined"
  set_fact:
    ssh_user_defined: "{{ lookup('env','SSH_USER') | default('') | length > 0 }}"

- name: "SSH | Ensure SSH user exists"
  user:
    name: "{{ lookup('env','SSH_USER') }}"
    shell: /bin/bash
    create_home: true
    groups: sudo
    append: yes
    state: present
  when: ssh_user_defined | bool

- name: "SSH | Grant passwordless sudo access"
  lineinfile:
    path: /etc/sudoers.d/{{ lookup('env','SSH_USER') }}
    line: "{{ lookup('env','SSH_USER') }} ALL=(ALL) NOPASSWD:ALL"
    create: yes
    mode: '0440'
    validate: 'visudo -cf %s'
  when: ssh_user_defined | bool

############################################################
# 5. PREPARE .ssh DIRECTORY
############################################################

- name: "SSH | Fix home directory permissions"
  file:
    path: "/home/{{ lookup('env','SSH_USER') }}"
    owner: "{{ lookup('env','SSH_USER') }}"
    group: "{{ lookup('env','SSH_USER') }}"
    mode: "0755"
    state: directory
  when: ssh_user_defined | bool

- name: "SSH | Create .ssh directory"
  file:
    path: "/home/{{ lookup('env','SSH_USER') }}/.ssh"
    state: directory
    owner: "{{ lookup('env','SSH_USER') }}"
    group: "{{ lookup('env','SSH_USER') }}"
    mode: "0700"
  when: ssh_user_defined | bool

############################################################
# 6. VALIDATE KEYS DIRECTORY
############################################################

- name: "SSH | Check developer public keys directory exists"
  stat:
    path: "{{ lookup('env','SSH_KEYS_DIR') }}"
  register: ssh_keys_dir
  when: ssh_user_defined | bool

- name: "SSH | Create SSH_KEYS_DIR if missing"
  file:
    path: "{{ lookup('env','SSH_KEYS_DIR') }}"
    state: directory
    owner: root
    group: root
    mode: "0700"
  when:
    - ssh_user_defined | bool
    - not ssh_keys_dir.stat.exists

- name: "SSH | Warning about missing SSH keys"
  debug:
    msg: >
      WARNING: No SSH keys directory found at {{ lookup('env','SSH_KEYS_DIR') }}.
      Created empty directory. Please add .pub files manually if needed.
  when:
    - ssh_user_defined | bool
    - not ssh_keys_dir.stat.exists

############################################################
# 7. LOAD ALL PUBLIC KEYS
############################################################

- name: "SSH | Read all developer public keys"
  find:
    paths: "{{ lookup('env','SSH_KEYS_DIR') }}"
    patterns: "*"
    file_type: file
  register: pub_keys
  when: ssh_user_defined | bool

- name: "SSH | Warning if no public keys found"
  debug:
    msg: "WARNING: No public key files found in {{ lookup('env','SSH_KEYS_DIR') }}"
  when:
    - ssh_user_defined | bool
    - pub_keys.matched == 0

############################################################
# 8. INSTALL AUTHORIZED KEYS
############################################################

- name: "SSH | Add developer public keys to authorized_keys"
  authorized_key:
    user: "{{ lookup('env','SSH_USER') }}"
    key: "{{ lookup('file', item.path) }}"
    state: present
  loop: "{{ pub_keys.files }}"
  when:
    - ssh_user_defined | bool
    - pub_keys.matched > 0

############################################################
# 9. FIX PERMISSIONS (CRITICAL)
############################################################

- name: "SSH | Set permissions on authorized_keys"
  file:
    path: "/home/{{ lookup('env','SSH_USER') }}/.ssh/authorized_keys"
    owner: "{{ lookup('env','SSH_USER') }}"
    group: "{{ lookup('env','SSH_USER') }}"
    mode: "0600"
  when:
    - ssh_user_defined | bool
    - pub_keys.matched > 0

############################################################
# 10. CONFIGURE SSH DAEMON FOR KEY-BASED AUTH
############################################################

- name: "SSH | Ensure PubkeyAuthentication is enabled"
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PubkeyAuthentication'
    line: 'PubkeyAuthentication yes'
    state: present
  register: ssh_pubkey_config

- name: "SSH | Ensure PasswordAuthentication is disabled"
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present
  register: ssh_password_config

- name: "SSH | Ensure AuthorizedKeysFile is set correctly"
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?AuthorizedKeysFile'
    line: 'AuthorizedKeysFile .ssh/authorized_keys'
    state: present
  register: ssh_authkeys_config

- name: "SSH | Validate sshd configuration"
  command: sshd -t
  register: sshd_test
  changed_when: false

- name: "SSH | Restart SSH service to apply configuration changes"
  service:
    name: ssh
    state: restarted
  when: 
    - ssh_user_defined | bool
    - (ssh_pubkey_config.changed or ssh_password_config.changed or ssh_authkeys_config.changed)

############################################################
# 11. FINAL STATUS
############################################################

- name: "SSH | SSH access configuration completed"
  debug:
    msg:
      - "OpenSSH server: OK"
      - "SSH service running: OK"
      - "SSH port listening: OK"
      - "User '{{ lookup('env','SSH_USER') }}' configured: {{ ssh_user_defined }}"
      - "Developer keys installed: {{ pub_keys.matched if ssh_user_defined else 0 }}"
