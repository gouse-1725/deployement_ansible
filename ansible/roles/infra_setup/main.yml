---
############################################################
# ROLE: infra_setup
#
# Purpose:
# - Prepare base OS
# - Install core infrastructure packages
# - Ensure required services are enabled & running
# - Fail early and clearly on unsupported systems
#
# Tags:
# - infra
############################################################

############################################################
# 1. FACT VALIDATION
############################################################

- name: "INFRA | Validate OS family"
  assert:
    that:
      - ansible_system == "Linux"
      - ansible_os_family == "Debian"
    fail_msg: >
      Unsupported system detected.
      Only Debian/Ubuntu Linux is supported.
    success_msg: "OS validation successful"

############################################################
# 2. TIMEZONE CONFIGURATION
############################################################

- name: "INFRA | Set system timezone"
  timezone:
    name: "{{ lookup('env','TIMEZONE') | default('UTC') }}"
  register: timezone_result

- name: "INFRA | Timezone status"
  debug:
    msg: >
      Timezone {{
        'updated' if timezone_result.changed
        else 'already correct'
      }}

############################################################
# 3. APT PACKAGE CACHE
############################################################

- name: "INFRA | Update apt package cache"
  apt:
    update_cache: yes
    cache_valid_time: 3600

############################################################
# 4. BASE SYSTEM PACKAGES
############################################################

- name: "INFRA | Install base system packages"
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      - git
      - python3
      - python3-pip
      - openssh-server
    state: present
  register: base_packages

- name: "INFRA | Base packages status"
  debug:
    msg: >
      Base packages {{
        'installed/updated' if base_packages.changed
        else 'already present'
      }}

############################################################
# 5. DOCKER ENGINE
############################################################

- name: "INFRA | Check if Docker is installed"
  command: docker --version
  register: docker_check
  failed_when: false
  changed_when: false

# Try Docker CE from official repo first
- block:
  - name: "INFRA | Add Docker GPG key"
    apt_key:
      url: https://download.docker.com/linux/ubuntu/gpg
      state: present
    ignore_errors: yes

  - name: "INFRA | Get Ubuntu codename"
    shell: lsb_release -cs
    register: ubuntu_codename
    changed_when: false

  - name: "INFRA | Add Docker repository"
    apt_repository:
      repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ubuntu_codename.stdout }} stable"
      state: present
      filename: docker
    ignore_errors: yes

  - name: "INFRA | Update apt cache"
    apt:
      update_cache: yes

  - name: "INFRA | Install Docker CE"
    apt:
      name:
        - docker-ce
        - docker-ce-cli
        - containerd.io
      state: present
    register: docker_ce_install
  
  rescue:
    - name: "INFRA | Fallback - Install Docker.io"
      apt:
        name: docker.io
        state: present
      register: docker_io_install

  when: docker_check.rc != 0

- name: "INFRA | Enable & start Docker service"
  service:
    name: docker
    state: started
    enabled: true

- name: "INFRA | Docker status"
  debug:
    msg: >
      Docker {{
        'installed now' if docker_check.rc != 0
        else 'already installed'
      }}

############################################################
# 6. DOCKER COMPOSE (PLUGIN OR STANDALONE)
############################################################

- name: "INFRA | Check Docker Compose"
  shell: docker compose version 2>/dev/null || docker-compose version 2>/dev/null || echo "not installed"
  register: compose_check
  failed_when: false
  changed_when: false

# Try multiple methods to install docker-compose
- block:
  # Method 1: Try docker-compose-plugin from Docker repo
  - name: "INFRA | Install Docker Compose plugin"
    apt:
      name: docker-compose-plugin
      state: present
    register: compose_plugin_install

  rescue:
    # Method 2: Try python3-docker-compose from apt
    - name: "INFRA | Fallback - Try apt python3-docker-compose"
      apt:
        name: python3-docker-compose
        state: present
      register: compose_apt_install
      ignore_errors: yes

    # Method 3: Download docker-compose binary directly
    - name: "INFRA | Fallback - Download docker-compose binary"
      get_url:
        url: https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-x86_64
        dest: /usr/local/bin/docker-compose
        mode: '0755'
      when: compose_apt_install.failed | default(false)
      register: compose_binary_install

    # Method 4: Create docker compose plugin symlink
    - name: "INFRA | Create docker CLI plugins directory"
      file:
        path: /usr/libexec/docker/cli-plugins
        state: directory
        mode: "0755"
        recurse: yes
      when: compose_binary_install.changed | default(false)

    - name: "INFRA | Create docker compose plugin symlink"
      file:
        src: /usr/local/bin/docker-compose
        dest: /usr/libexec/docker/cli-plugins/docker-compose
        state: link
        force: yes
      when: compose_binary_install.changed | default(false)

  when: "'not installed' in compose_check.stdout or compose_check.rc != 0"

- name: "INFRA | Verify Docker Compose installation"
  shell: docker compose version 2>/dev/null || docker-compose version
  register: final_compose_check
  changed_when: false

- name: "INFRA | Docker Compose status"
  debug:
    msg: "Docker Compose installed: {{ final_compose_check.stdout_lines[0] }}"

############################################################
# 7. NGINX
############################################################

- name: "INFRA | Install Nginx"
  apt:
    name: nginx
    state: present
  register: nginx_install

- name: "INFRA | Ensure Nginx is enabled"
  service:
    name: nginx
    enabled: true

- name: "INFRA | Nginx status"
  debug:
    msg: >
      Nginx {{
        'installed/started' if nginx_install.changed
        else 'already running'
      }}

############################################################
# 8. CERTBOT
############################################################

- name: "INFRA | Install Certbot and Nginx plugin"
  apt:
    name:
      - certbot
      - python3-certbot-nginx
    state: present
  register: certbot_install

- name: "INFRA | Certbot status"
  debug:
    msg: >
      Certbot {{
        'installed/updated' if certbot_install.changed
        else 'already present'
      }}

############################################################
# 9. SSH SERVICE
############################################################

- name: "INFRA | Enable & start SSH service"
  service:
    name: ssh
    state: started
    enabled: true

- name: "INFRA | Verify SSH port is listening"
  wait_for:
    port: "{{ lookup('env','SSH_PORT') | default('22') }}"
    timeout: 10

############################################################
# 10. PYTHON LIBRARIES FOR ANSIBLE MODULES
############################################################

- name: "INFRA | Install Python libraries for Docker modules"
  pip:
    name:
      - docker
    state: present
    extra_args: --break-system-packages
  ignore_errors: yes
  register: pip_docker_install

- name: "INFRA | Fallback - Install python3-docker from apt"
  apt:
    name: python3-docker
    state: present
  when: pip_docker_install.failed | default(false)

- name: "INFRA | Create docker CLI plugins directory"
  file:
    path: /usr/libexec/docker/cli-plugins
    state: directory
    mode: "0755"
    recurse: yes

- name: "INFRA | Ensure docker-compose is accessible"
  shell: |
    if command -v docker-compose >/dev/null 2>&1; then
      ln -sf $(which docker-compose) /usr/libexec/docker/cli-plugins/docker-compose 2>/dev/null || true
      ln -sf $(which docker-compose) /usr/local/bin/docker-compose 2>/dev/null || true
    fi
  args:
    executable: /bin/bash
  changed_when: false

############################################################
# 11. CREATE REQUIRED DIRECTORIES WITH PERMISSIONS
############################################################

- name: "INFRA | Create installation base directory"
  file:
    path: "{{ lookup('env','INSTALL_DIR') }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: "INFRA | Create log directories"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
    recurse: yes
  loop:
    - "{{ lookup('env','LOG_BASE_DIR') }}"
    - "{{ lookup('env','APP_LOG_DIR') }}"
    - "{{ lookup('env','DZI_LOG_DIR') }}"
    - "{{ lookup('env','MINIO_LOG_DIR') }}"

- name: "INFRA | Create MinIO data and config directories"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
    recurse: yes
  loop:
    - "{{ lookup('env','MINIO_DATA_DIR') }}"
    - "{{ lookup('env','MINIO_CERTS_DIR') }}"
    - "{{ lookup('env','MINIO_CONFIG_DIR') }}"

- name: "INFRA | Create backup directories"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0750"
  loop:
    - "{{ lookup('env','BACKUP_BASE_DIR') }}"
    - "{{ lookup('env','DB_BACKUP_DIR') }}"
    - "{{ lookup('env','LOG_BACKUP_DIR') }}"

- name: "INFRA | Create SSH keys directory"
  file:
    path: "{{ lookup('env','SSH_KEYS_DIR') }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: "INFRA | Create NGINX log directories from config paths"
  file:
    path: "{{ item | dirname }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
    recurse: yes
  loop:
    - "{{ lookup('env','NGINX_ACCESS_LOG') }}"
    - "{{ lookup('env','NGINX_ERROR_LOG') }}"
    - "{{ lookup('env','NGINX_MINIO_ACCESS_LOG') }}"
    - "{{ lookup('env','NGINX_MINIO_ERROR_LOG') }}"
  when: item | length > 0

############################################################
# 12. CONFIGURE FIREWALL (UFW)
############################################################

- name: "INFRA | Install UFW firewall"
  apt:
    name: ufw
    state: present

- name: "INFRA | Allow SSH through firewall"
  ufw:
    rule: allow
    port: "{{ lookup('env','SSH_PORT') | default('22') }}"
    proto: tcp
  when: lookup('env','ENABLE_FIREWALL') | default('false') | lower == 'true'

- name: "INFRA | Allow HTTP through firewall"
  ufw:
    rule: allow
    port: "{{ lookup('env','NGINX_HTTP_PORT') | default('80') }}"
    proto: tcp
  when: lookup('env','ENABLE_FIREWALL') | default('false') | lower == 'true'

- name: "INFRA | Allow HTTPS through firewall"
  ufw:
    rule: allow
    port: "{{ lookup('env','NGINX_HTTPS_PORT') | default('443') }}"
    proto: tcp
  when: lookup('env','ENABLE_FIREWALL') | default('false') | lower == 'true'

- name: "INFRA | Allow MinIO SSL through firewall"
  ufw:
    rule: allow
    port: "{{ lookup('env','MINIO_SSL_PORT') | default('9009') }}"
    proto: tcp
  when: lookup('env','ENABLE_FIREWALL') | default('false') | lower == 'true'

- name: "INFRA | Enable UFW firewall"
  ufw:
    state: enabled
  when: lookup('env','ENABLE_FIREWALL') | default('false') | lower == 'true'

############################################################
# 13. FINAL SUMMARY
############################################################

- name: "INFRA | Infrastructure setup completed"
  debug:
    msg:
      - "Base OS packages: OK"
      - "Docker engine: OK"
      - "Docker Compose: OK"
      - "Nginx: OK"
      - "Certbot: OK"
      - "SSH service: OK"
      - "Python Docker SDK: OK"
      - "Required directories created: OK"
      - "Firewall configured: {{ lookup('env','ENABLE_FIREWALL') | default('false') }}"
