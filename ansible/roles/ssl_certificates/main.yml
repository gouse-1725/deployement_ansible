---
############################################################
# ROLE: ssl_certificates
#
# Purpose:
# - Generate SSL certificates using Certbot
# - Run fully non-interactive
# - Skip if cert already exists
# - Enable auto-renewal
#
# Tags:
# - ssl
############################################################

############################################################
# 1. VALIDATE REQUIRED VARIABLES
############################################################

- name: "SSL | Validate required environment variables"
  assert:
    that:
      - lookup('env','NGINX_SERVER_NAME') | length > 0
      - lookup('env','CERTBOT_EMAIL') | length > 0
    fail_msg: >
      SSL configuration missing.
      NGINX_SERVER_NAME and CERTBOT_EMAIL must be set in config.env
    success_msg: "SSL variables validated"

############################################################
# 2. ENSURE CERTBOT INSTALLED
############################################################

- name: "SSL | Ensure Certbot and nginx plugin installed"
  apt:
    name:
      - certbot
      - python3-certbot-nginx
    state: present
    update_cache: yes

############################################################
# 3. CHECK IF CERTIFICATE ALREADY EXISTS
############################################################

- name: "SSL | Check if certificate already exists"
  stat:
    path: "/etc/letsencrypt/live/{{ lookup('env','NGINX_SERVER_NAME') }}/fullchain.pem"
  register: cert_exists

############################################################
# 4. OBTAIN CERTIFICATE (NON-INTERACTIVE)
############################################################

- name: "SSL | Obtain SSL certificate (non-interactive)"
  command: >
    certbot --nginx
    --non-interactive
    --agree-tos
    --email {{ lookup('env','CERTBOT_EMAIL') }}
    -d {{ lookup('env','NGINX_SERVER_NAME') }}
    --redirect
  when: not cert_exists.stat.exists
  register: certbot_result
  failed_when: certbot_result.rc != 0

############################################################
# 5. VALIDATE CERTIFICATE FILES
############################################################

- name: "SSL | Validate certificate files exist"
  stat:
    path: "/etc/letsencrypt/live/{{ lookup('env','NGINX_SERVER_NAME') }}/privkey.pem"
  register: cert_key

- name: "SSL | Fail if certificate generation failed"
  fail:
    msg: "SSL certificate generation failed for {{ lookup('env','NGINX_SERVER_NAME') }}"
  when: not cert_key.stat.exists

############################################################
# 6. ENABLE AUTO-RENEWAL
############################################################

- name: "SSL | Ensure Certbot auto-renewal timer enabled"
  service:
    name: certbot.timer
    state: started
    enabled: true
  ignore_errors: true

############################################################
# 7. TEST RENEWAL (DRY RUN)
############################################################

- name: "SSL | Test certificate renewal (dry-run)"
  command: certbot renew --dry-run
  register: renew_test
  changed_when: false
  failed_when: renew_test.rc != 0

############################################################
# 8. UPDATE NGINX CONFIG TO HTTPS AND RESTART
############################################################

- name: "SSL | Update nginx configuration to HTTPS (with SSL)"
  template:
    src: nginx.conf.j2
    dest: "/etc/nginx/sites-available/{{ lookup('env','APP_NAME') }}"
    owner: root
    group: root
    mode: "0644"
  when: 
    - lookup('env','NGINX_SERVER_NAME') | length > 0
    - cert_exists.stat.exists

- name: "SSL | Validate nginx configuration with SSL"
  command: nginx -t
  register: nginx_ssl_test
  changed_when: false
  failed_when: nginx_ssl_test.rc != 0
  when: 
    - lookup('env','NGINX_SERVER_NAME') | length > 0
    - cert_exists.stat.exists

- name: "SSL | Restart nginx to apply SSL configuration"
  service:
    name: nginx
    state: restarted
    enabled: true
  when: 
    - lookup('env','NGINX_SERVER_NAME') | length > 0
    - cert_exists.stat.exists

############################################################
# 9. FINAL STATUS
############################################################

- name: "SSL | SSL certificate configured successfully"
  debug:
    msg:
      - "SSL certificate ready for {{ lookup('env','NGINX_SERVER_NAME') }}"
      - "Auto-renewal enabled"
      - "Nginx reloaded with HTTPS"
