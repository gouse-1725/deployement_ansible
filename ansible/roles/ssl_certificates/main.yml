---
############################################################
# ROLE: ssl_certificates
#
# Purpose:
# - Generate SSL certificates using Certbot
# - Run fully non-interactive
# - Skip if cert already exists
# - Enable auto-renewal
#
# Tags:
# - ssl
############################################################

############################################################
# 1. VALIDATE REQUIRED VARIABLES
############################################################

- name: "SSL | Validate required environment variables"
  assert:
    that:
      - lookup('env','NGINX_SERVER_NAME') | length > 0
      - lookup('env','CERTBOT_EMAIL') | length > 0
    fail_msg: >
      SSL configuration missing.
      NGINX_SERVER_NAME and CERTBOT_EMAIL must be set in config.env
    success_msg: "SSL variables validated"

############################################################
# 2. ENSURE CERTBOT INSTALLED
############################################################

- name: "SSL | Ensure Certbot and nginx plugin installed"
  apt:
    name:
      - certbot
      - python3-certbot-nginx
    state: present
    update_cache: yes

############################################################
# 3. CHECK IF CERTIFICATE ALREADY EXISTS
############################################################

- name: "SSL | Check if certificate already exists"
  stat:
    path: "/etc/letsencrypt/live/{{ lookup('env','NGINX_SERVER_NAME') }}/fullchain.pem"
  register: cert_exists

############################################################
# 4. OBTAIN CERTIFICATE (NON-INTERACTIVE)
############################################################

- name: "SSL | Obtain SSL certificate (non-interactive)"
  command: >
    certbot --nginx
    --non-interactive
    --agree-tos
    --email {{ lookup('env','CERTBOT_EMAIL') }}
    -d {{ lookup('env','NGINX_SERVER_NAME') }}
    --redirect
  when: not cert_exists.stat.exists
  register: certbot_result
  failed_when: certbot_result.rc != 0

############################################################
# 5. VALIDATE CERTIFICATE FILES
############################################################

- name: "SSL | Validate certificate files exist"
  stat:
    path: "/etc/letsencrypt/live/{{ lookup('env','NGINX_SERVER_NAME') }}/privkey.pem"
  register: cert_key

- name: "SSL | Fail if certificate generation failed"
  fail:
    msg: "SSL certificate generation failed for {{ lookup('env','NGINX_SERVER_NAME') }}"
  when: not cert_key.stat.exists

############################################################
# 6. ENABLE AUTO-RENEWAL
############################################################

- name: "SSL | Ensure Certbot auto-renewal timer enabled"
  service:
    name: certbot.timer
    state: started
    enabled: true
  ignore_errors: true

############################################################
# 7. TEST RENEWAL (DRY RUN)
############################################################

- name: "SSL | Test certificate renewal (dry-run)"
  command: certbot renew --dry-run
  register: renew_test
  changed_when: false
  failed_when: renew_test.rc != 0

############################################################
# 8. UPDATE NGINX CONFIG TO HTTPS AND RESTART
############################################################

- name: "SSL | Update nginx configuration to HTTPS (with SSL)"
  template:
    src: nginx.conf.j2
    dest: "/etc/nginx/sites-available/{{ lookup('env','APP_NAME') }}"
    owner: root
    group: root
    mode: "0644"
  when: 
    - lookup('env','NGINX_SERVER_NAME') | length > 0
    - cert_exists.stat.exists

- name: "SSL | Validate nginx configuration with SSL"
  command: nginx -t
  register: nginx_ssl_test
  changed_when: false
  failed_when: nginx_ssl_test.rc != 0
  when: 
    - lookup('env','NGINX_SERVER_NAME') | length > 0
    - cert_exists.stat.exists

- name: "SSL | Restart nginx to apply SSL configuration"
  service:
    name: nginx
    state: restarted
    enabled: true
  when: 
    - lookup('env','NGINX_SERVER_NAME') | length > 0
    - cert_exists.stat.exists

############################################################
# 9. COPY CERTIFICATES TO MINIO CERTS DIRECTORY
############################################################

- name: "SSL | Ensure MinIO certs directory exists"
  file:
    path: "{{ lookup('env','MINIO_CERTS_DIR') }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
    recurse: yes

- name: "SSL | Copy SSL certificate to MinIO (public.crt)"
  copy:
    src: "/etc/letsencrypt/live/{{ lookup('env','NGINX_SERVER_NAME') }}/fullchain.pem"
    dest: "{{ lookup('env','MINIO_CERTS_DIR') }}/public.crt"
    remote_src: yes
    owner: root
    group: root
    mode: "0644"
  when: cert_exists.stat.exists or cert_key.stat.exists
  register: minio_public_cert

- name: "SSL | Copy SSL private key to MinIO (private.key)"
  copy:
    src: "/etc/letsencrypt/live/{{ lookup('env','NGINX_SERVER_NAME') }}/privkey.pem"
    dest: "{{ lookup('env','MINIO_CERTS_DIR') }}/private.key"
    remote_src: yes
    owner: root
    group: root
    mode: "0600"
  when: cert_exists.stat.exists or cert_key.stat.exists
  register: minio_private_key

- name: "SSL | MinIO SSL certificates copied"
  debug:
    msg: "SSL certificates copied to MinIO certs directory"
  when: minio_public_cert.changed or minio_private_key.changed

############################################################
# 10. CREATE CERTBOT RENEWAL HOOK FOR MINIO
############################################################

- name: "SSL | Create Certbot renewal hook directory"
  file:
    path: /etc/letsencrypt/renewal-hooks/deploy
    state: directory
    owner: root
    group: root
    mode: "0755"
    recurse: yes

- name: "SSL | Create renewal hook script for MinIO"
  copy:
    dest: /etc/letsencrypt/renewal-hooks/deploy/minio-cert-update.sh
    owner: root
    group: root
    mode: "0755"
    content: |
      #!/bin/bash
      # Copy renewed certificates to MinIO
      cp /etc/letsencrypt/live/{{ lookup('env','NGINX_SERVER_NAME') }}/fullchain.pem {{ lookup('env','MINIO_CERTS_DIR') }}/public.crt
      cp /etc/letsencrypt/live/{{ lookup('env','NGINX_SERVER_NAME') }}/privkey.pem {{ lookup('env','MINIO_CERTS_DIR') }}/private.key
      chmod 644 {{ lookup('env','MINIO_CERTS_DIR') }}/public.crt
      chmod 600 {{ lookup('env','MINIO_CERTS_DIR') }}/private.key
      # Restart MinIO container to reload certificates
      docker restart {{ lookup('env','MINIO_CONTAINER_NAME') }} 2>/dev/null || true

- name: "SSL | Certbot renewal hook created"
  debug:
    msg: "Renewal hook will automatically update MinIO certificates"

############################################################
# 11. FINAL STATUS
############################################################

- name: "SSL | SSL certificate configured successfully"
  debug:
    msg:
      - "SSL certificate ready for {{ lookup('env','NGINX_SERVER_NAME') }}"
      - "Auto-renewal enabled"
      - "Nginx reloaded with HTTPS"
      - "MinIO SSL certificates configured"
      - "Renewal hook created for automatic updates"
